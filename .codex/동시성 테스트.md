# 동시성 테스트 결과

## 1. 문서 목적
- `OrderConcurrencyTest` 실패 원인과 수정 내역을 제3자가 빠르게 파악할 수 있도록 정리한다.
- 테스트 빌드 실패 원인, 동시성 300건 실패 원인, 실제 수정 사항, 최종 검증 결과를 남긴다.

## 2. 테스트 빌드 실패 원인(시점별)

### 2.1 1차 실패: 테스트 DB 미존재
- 증상: `Unknown database 'ecommerce_test'`
- 원인: 테스트 프로파일(`application-test.yml`)에서 지정한 DB가 없어서 JPA 초기화 실패
- 조치: 테스트 DB 자동 생성 옵션 적용(`createDatabaseIfNotExist=true`)

### 2.2 2차 실패: `ObjectMapper` 빈 주입 실패
- 증상: `No qualifying bean of type 'ObjectMapper'`
- 원인: 테스트 컨텍스트에서 `ObjectMapper` 빈 주입에 의존
- 조치: 테스트 내부에서 `jacksonObjectMapper()`를 직접 생성해 요청 JSON 직렬화에 사용

### 2.3 3차 실패: 동시 요청 준비 래치 타임아웃
- 증상: `동시 요청 준비 단계에서 타임아웃 발생`
- 원인: 동시성은 300인데 스레드풀이 64라서 `ready` 래치가 제한 시간 내 0에 도달하지 못함
- 조치: `Executors.newFixedThreadPool(64)` -> `Executors.newFixedThreadPool(concurrency)`

### 2.4 4차 실패: 300건 모두 `NullPointerException`
- 증상: `errors={ServletException:NullPointerException=300}`
- 원인: `MockMvc` 호출에서 보안 필터 체인이 빠져 `@AuthenticationPrincipal`이 정상 주입되지 않음
- 조치: 테스트 `MockMvc` 구성 시 `springSecurityFilterChain`을 필터로 추가

### 2.5 5차 실패: 300건 모두 `LazyInitializationException`
- 증상: `errors={ServletException:LazyInitializationException=300}`
- 원인: 주문 생성 시 `getReferenceById`로 가져온 프록시(`User`, `Product`)를 응답 변환 시 접근
- 상세 원인: 재고 차감 쿼리(`decreaseStock`)가 `clearAutomatically = true`로 동작하면서 영속성 컨텍스트가 정리되고, 프록시 접근 시 지연 로딩 예외 발생

## 3. 동시성 300건 실패 원인(현재 로직 기준)
- 실패 지점은 요청 자체가 아니라, 주문 처리 후 응답(`OrderResponse.of(order)`) 생성 단계였다.
- 기존 로직은 `OrderCommander`에서 `userReference/productReference` 프록시를 사용했다.
- 같은 트랜잭션 내부라도, 재고 차감 업데이트 이후 컨텍스트 정리로 프록시가 안전하지 않아졌고, 응답 매핑에서 필드 접근 시 `LazyInitializationException`이 발생했다.
- 결과적으로 300건 요청이 모두 실패로 집계되었다.

## 4. 적용한 수정 사항

### 4.1 테스트 코드 수정 (`src/test/kotlin/small/ecommerce/order/OrderConcurrencyTest.kt`)
- `ObjectMapper`를 `@Autowired` 대신 `jacksonObjectMapper()`로 직접 생성
- `MockMvc`에 보안 필터(`springSecurityFilterChain`)를 명시적으로 추가
- 스레드풀 크기를 `concurrency`와 동일하게 변경
- `Given/When/Then` 기반 상세 주석 추가

### 4.2 도메인 로직 수정 (`src/main/kotlin/small/ecommerce/domain/order/OrderCommander.kt`)
- `userService.userReference(userId)` -> `userService.getUserByUserId(userId)`
- `productService.productReference(productId)` 반복 조회 제거
- `productService.readProductListByProductIdList(uniqueProductIds)`로 실제 엔티티 일괄 조회 후 맵으로 사용
- 응답 변환 시 프록시 지연 로딩 예외가 발생하지 않도록 변경

## 5. 최종 검증 결과
- 단건 검증: `./gradlew test --tests "small.ecommerce.order.OrderConcurrencyTest"` 통과
- 전체 검증: `./gradlew test` 통과 (`BUILD SUCCESSFUL`)
- 최종 상태: 테스트 2건 중 실패 0건

## 6. 참고 사항
- 로그 초반의 `Table ... doesn't exist` 메시지는 `create-drop` 전략의 `drop` 단계 경고이며, 이후 `create table`이 정상 수행되면 치명 오류가 아니다.
